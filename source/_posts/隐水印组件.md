---
title: 隐水印组件
date: 2021-02-14 21:20:45
tags:
categories: 技术
---

业务上沉淀的水印组件。

1. 组件仓库地址：`https://github.com/ILovePing/invisible-watermark`

2. 组件设计
   ![image](https://user-images.githubusercontent.com/13430709/94658082-ef208280-0334-11eb-8878-2d20fe5497cc.png)

3. 水印种类

   1. 背景图
      a. dom 直接插入，平铺在页面 body 上。
      b. canvas 绘制，导出为 base64 或者 blob 作为元素的 background-image。
      c. svg 绘制，通过 svg 的 text 元素绘制，最终也是和 canvas 一样转化成 dataUrl 作为元素的背景图。

   2. 数字水印
      参考第三方包实现：digital-watermarking。

4. 封装组件
   将以上 canvas/svg 绘制水印图片封装成组件形式：invisible-watermark，使用文档见 git readme。

### **水印攻防**

1. **攻**常见水印为可见水印，攻击者很容易能避开有水印的位置截图，或者通过控制台将 background-image 注释掉以达到去掉水印的效果。
   ![image](https://user-images.githubusercontent.com/13430709/62448019-4ced2500-b799-11e9-9aa4-0f26145027ac.png)

2. **防**针对全局添加额外的一层不可见的隐水印，并添加[mutationObserver](https://javascript.ruanyifeng.com/dom/mutationobserver.html)监听属性变更，使攻击者无法通过控制台简单的注释掉背景水印，对于泄露的数据原图，可通过 ps->色阶调整可追踪用户信息。
   ![image](https://user-images.githubusercontent.com/13430709/62448978-aa827100-b79b-11e9-9b1e-34efab1c5d69.png)

![image](https://user-images.githubusercontent.com/13430709/62448346-2b406d80-b79a-11e9-95d4-80c5d9d5c7b9.png)

3. **攻**攻击者知晓了页面存在不可删除不可注释的水印后，可以通过控制台对存在水印的元素插入 style 覆盖样式。
   ![image](https://user-images.githubusercontent.com/13430709/62448516-9f7b1100-b79a-11e9-85bb-80b1b3ad2a87.png)

4. **防**得知攻击者可以通过控制台插入样式，我们尝试阻止攻击者打开控制台。
   这时候你肯定想到了禁用右键事件，但是别忘了还有快捷键可以打开控制台，难道我们还要禁用掉对应的快捷键吗？（换个热键也能打开），明显不可能。尝试转换方向，控制台可以打开，但是有没有什么办法监听打开事件呢，我们只要能监听到，在打开控制台的时候隐藏掉重要的隐私数据那不就好啦。有如下两个方法：<br /> 1. **[适用于大多浏览器，受限于弹出式控制台页面]**控制台打开页面会重新 resize，监听 resize 事件，但是控制台也可以在一个独立的窗口打开，pass<br /> 2. **[适用 Chrome 浏览器，受限于非 Chrome 浏览器]**浏览器在打开控制台时会执行 console.log 输出某个对象，这时是会去 get 对象属性的 id，我们可以通过 Object.defineProperty 自定义对象属性 id 的 getter 方法来监听控制台打开。可以了解一下有第三方包专门检测控制台的打开：[https://github.com/AepKill/devtools-detector](https://github.com/AepKill/devtools-detector)

```javascript
<script>
    var el = new Image();
    Object.defineProperty(el, 'id', {
        get: function() {
            alert('控制台打开，隐藏隐私数据');
        }
    });
    console.log(el);
  </script>
```

5. **攻**不能从控制台插入样式，换个角度：浏览器地址栏支持 javascript 协议，只要是 javascript:开头，后续的 js 语句可以直接执行，攻击者可以通过浏览器地址栏执行 js，插入 style 样式，将所有 div 元素的背景设为 none 即可除掉水印。

6. **攻**无法从控制台入手，攻击者还可以通过 chromium 浏览器内核模拟浏览器访问，通过插入脚本，对访问页面截图导出也可以实现隐藏水印得到数据截图的效果。

7. **防**综上可见，道高一尺魔高一丈，浏览器上直接通过文本渲染的数据肯定是有办法“安全”的拿到的，因此**终极方案就是直接使用 canvas 渲染**，水印直接画在画布上，这样就无法简单的通过 js、css 求水印啦，并且对于图片音频等多媒体文件还可以加上数字水印的方式达到追踪防篡改的效果，可了解一下数字水印的实现原理：[https://www.jianshu.com/p/62e52c4ab5c4](https://www.jianshu.com/p/62e52c4ab5c4)以及 node 实现的 npm 包：[digital-watermarking](https://github.com/zy445566/node-digital-watermarking)
